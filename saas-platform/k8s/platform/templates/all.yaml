# Platform Services Deployment
---
apiVersion: v1
kind: Namespace
metadata:
  name: mindroom-{{ .Values.environment }}
---
# Secrets for platform services
apiVersion: v1
kind: Secret
metadata:
  name: platform-secrets
  namespace: mindroom-{{ .Values.environment }}
type: Opaque
stringData:
  PLATFORM_DOMAIN: {{ .Values.domain }}
  ENVIRONMENT: {{ .Values.environment }}
  SUPABASE_URL: {{ .Values.supabase.url }}
  SUPABASE_ANON_KEY: {{ .Values.supabase.anonKey }}
  SUPABASE_SERVICE_KEY: {{ .Values.supabase.serviceKey }}
  STRIPE_PUBLISHABLE_KEY: {{ .Values.stripe.publishableKey }}
  STRIPE_SECRET_KEY: {{ .Values.stripe.secretKey }}
  STRIPE_WEBHOOK_SECRET: {{ .Values.stripe.webhookSecret }}
  STRIPE_PRICE_STARTER: {{ .Values.stripe.priceStarter }}
  STRIPE_PRICE_PROFESSIONAL: {{ .Values.stripe.priceProfessional }}
  STRIPE_PRICE_ENTERPRISE: {{ .Values.stripe.priceEnterprise }}
  PROVISIONER_API_KEY: {{ .Values.provisioner.apiKey }}
  PROVISIONER_URL: "http://instance-provisioner:8002"
  GITEA_USER: {{ .Values.gitea.user }}
  GITEA_TOKEN: {{ .Values.gitea.token }}
---
# Docker registry secret
apiVersion: v1
kind: Secret
metadata:
  name: gitea-registry
  namespace: mindroom-{{ .Values.environment }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf "{\"auths\":{\"git.nijho.lt\":{\"username\":\"basnijholt\",\"password\":\"%s\",\"auth\":\"%s\"}}}" .Values.gitea.token (printf "basnijholt:%s" .Values.gitea.token | b64enc) | b64enc }}
---
# Customer Portal
apiVersion: apps/v1
kind: Deployment
metadata:
  name: customer-portal
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: customer-portal
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: customer-portal
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: customer-portal
        environment: {{ .Values.environment }}
    spec:
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/customer-portal:{{ .Values.imageTag }}
        ports:
        - containerPort: 3000
        envFrom:
        - secretRef:
            name: platform-secrets
        env:
        - name: NODE_ENV
          value: production
        - name: APP_URL
          value: https://app.{{ .Values.domain }}
        # Map standard env vars to Next.js public env vars
        - name: SUPABASE_URL
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: SUPABASE_URL
        - name: SUPABASE_ANON_KEY
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: SUPABASE_ANON_KEY
---
apiVersion: v1
kind: Service
metadata:
  name: customer-portal
  namespace: mindroom-{{ .Values.environment }}
spec:
  selector:
    app: customer-portal
    environment: {{ .Values.environment }}
  ports:
  - port: 3000
    targetPort: 3000
---
# Admin API (Backend for admin dashboard)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: admin-api
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: admin-api
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: admin-api
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: admin-api
        environment: {{ .Values.environment }}
    spec:
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/admin-api:{{ .Values.imageTag }}
        ports:
        - containerPort: 8000
        envFrom:
        - secretRef:
            name: platform-secrets
        env:
        - name: ADMIN_EMAIL
          value: "admin@mindroom.chat"
        - name: ADMIN_PASSWORD
          value: "{{ .Values.adminPassword }}"
---
apiVersion: v1
kind: Service
metadata:
  name: admin-api
  namespace: mindroom-{{ .Values.environment }}
spec:
  selector:
    app: admin-api
    environment: {{ .Values.environment }}
  ports:
  - port: 8000
    targetPort: 8000
---
# Stripe Handler
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stripe-handler
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: stripe-handler
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: stripe-handler
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: stripe-handler
        environment: {{ .Values.environment }}
    spec:
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/stripe-handler:{{ .Values.imageTag }}
        ports:
        - containerPort: 3005
        envFrom:
        - secretRef:
            name: platform-secrets
---
apiVersion: v1
kind: Service
metadata:
  name: stripe-handler
  namespace: mindroom-{{ .Values.environment }}
spec:
  selector:
    app: stripe-handler
    environment: {{ .Values.environment }}
  ports:
  - port: 3005
    targetPort: 3005
---
# Instance Provisioner
apiVersion: apps/v1
kind: Deployment
metadata:
  name: instance-provisioner
  namespace: mindroom-{{ .Values.environment }}
  labels:
    app: instance-provisioner
    environment: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: instance-provisioner
      environment: {{ .Values.environment }}
  template:
    metadata:
      labels:
        app: instance-provisioner
        environment: {{ .Values.environment }}
    spec:
      serviceAccountName: instance-provisioner
      imagePullSecrets:
      - name: gitea-registry
      containers:
      - name: app
        image: {{ .Values.registry }}/instance-provisioner:{{ .Values.imageTag }}
        ports:
        - containerPort: 8002
        envFrom:
        - secretRef:
            name: platform-secrets
        env:
        - name: BASE_DOMAIN
          value: "{{ .Values.domain }}"
        - name: REGISTRY
          value: "{{ .Values.registry }}"
---
apiVersion: v1
kind: Service
metadata:
  name: instance-provisioner
  namespace: mindroom-{{ .Values.environment }}
spec:
  selector:
    app: instance-provisioner
    environment: {{ .Values.environment }}
  ports:
  - port: 8002
    targetPort: 8002
