#cloud-config
# Dokku Server Configuration - Using Native CloudInit Features

package_update: true
package_upgrade: true

# Create users with SSH keys - CloudInit native feature!
users:
  - default
  - name: dokku-deploy
    groups: [docker, sudo]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD: /usr/bin/dokku']
    ssh_authorized_keys:
      - ${provisioner_pub_key}

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - software-properties-common
  - git
  - ufw
  - fail2ban
  - htop
  - ncdu
  - tmux
  - wget
  - gnupg
  - lsb-release
  - nginx

# Write the Dokku installation script
write_files:
  - path: /root/setup-docker.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Add Docker's official GPG key
      mkdir -p /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

      # Add Docker repository
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

      # Install Docker
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      # Enable Docker service
      systemctl enable docker
      systemctl start docker

  - path: /root/install-dokku.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Install nginx first (required for Dokku web)
      apt-get update
      apt-get install -y nginx
      systemctl enable nginx
      systemctl start nginx

      # Configure Dokku installation
      export DEBIAN_FRONTEND=noninteractive
      echo 'dokku dokku/nginx_enable boolean true' | debconf-set-selections
      echo 'dokku dokku/hostname string ${dokku_domain}' | debconf-set-selections
      echo 'dokku dokku/skip_key_file boolean true' | debconf-set-selections
      echo 'dokku dokku/vhost_enable boolean true' | debconf-set-selections
      echo 'dokku dokku/web_config boolean true' | debconf-set-selections

      # Install Dokku
      apt-get install -y dokku=${dokku_version}

      # Enable nginx plugin explicitly
      dokku plugin:enable nginx-vhosts

      # Configure Dokku
      dokku domains:set-global ${dokku_domain}
      
      # Ensure nginx is configured for Dokku
      dokku nginx:set --global server-tokens off
      dokku nginx:set --global client-max-body-size 50m

      # Install plugins
      dokku plugin:install https://github.com/dokku/dokku-postgres.git postgres
      dokku plugin:install https://github.com/dokku/dokku-redis.git redis
      dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git
      dokku letsencrypt:cron-job --add
      dokku plugin:install https://github.com/dokku/dokku-resource-limit.git resource-limit

      # Add provisioner SSH key to Dokku
      cat > /tmp/provisioner.pub <<'KEYEOF'
      ${provisioner_pub_key}
      KEYEOF
      dokku ssh-keys:add provisioner < /tmp/provisioner.pub
      rm /tmp/provisioner.pub

      # Set admin password
      echo 'dokku:${admin_password}' > /tmp/dokku.pass
      chpasswd < /tmp/dokku.pass
      rm /tmp/dokku.pass

  - path: /root/setup-volume.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      # Mount Hetzner volume if it exists
      DEVICE=$(ls /dev/disk/by-id/scsi-0HC_Volume_* 2>/dev/null | head -n1)
      if [ -n "$DEVICE" ]; then
        if ! blkid $DEVICE >/dev/null 2>&1; then
          mkfs.ext4 $DEVICE
        fi
        mkdir -p /mnt/dokku-data
        if ! mountpoint -q /mnt/dokku-data; then
          mount $DEVICE /mnt/dokku-data
          UUID=$(blkid -s UUID -o value $DEVICE)
          if ! grep -q "$UUID" /etc/fstab; then
            echo "UUID=$UUID /mnt/dokku-data ext4 defaults,nofail 0 2" >> /etc/fstab
          fi
        fi

        # Move Docker and Dokku data to volume
        systemctl stop docker
        if [ -d /var/lib/docker ] && [ ! -L /var/lib/docker ]; then
          mv /var/lib/docker /mnt/dokku-data/
          ln -s /mnt/dokku-data/docker /var/lib/docker
        fi
        systemctl start docker

        if [ -d /home/dokku ] && [ ! -L /home/dokku ]; then
          mv /home/dokku /mnt/dokku-data/
          ln -s /mnt/dokku-data/dokku /home/dokku
        fi
      fi

  - path: /root/add-platform-key.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      # Add platform server's SSH key
      if [ -z "$1" ]; then
        echo "Usage: $0 'ssh-key'"
        exit 1
      fi
      if ! grep -q "$1" /root/.ssh/authorized_keys 2>/dev/null; then
        echo "$1" >> /root/.ssh/authorized_keys
        echo "Platform SSH key added successfully"
      else
        echo "Key already exists"
      fi

  - path: /etc/sysctl.d/99-dokku.conf
    content: |
      vm.max_map_count=262144
      net.core.somaxconn=65535
      net.ipv4.tcp_max_syn_backlog=65535
      net.ipv4.ip_local_port_range=1024 65535

# Simple runcmd - just run our scripts
runcmd:
  # System setup
  - sysctl -p /etc/sysctl.d/99-dokku.conf

  # Firewall
  - ufw --force enable
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 8448/tcp
  - ufw reload

  # Security
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Swap
  - fallocate -l 4G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - 'echo "/swapfile none swap sw 0 0" >> /etc/fstab'

  # Run setup scripts
  - bash /root/setup-volume.sh
  - bash /root/setup-docker.sh
  - bash /root/install-dokku.sh

final_message: |
  Dokku server setup complete!
  Dokku is ready to receive deployments.
