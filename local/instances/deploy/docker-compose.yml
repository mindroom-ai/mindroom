services:
  backend:
    image: ${BACKEND_IMAGE:-deploy-mindroom-backend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.backend
    container_name: ${INSTANCE_NAME:-mindroom}-backend
    restart: always
    env_file:
      - ../.env
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ${DATA_DIR}/config/config.yaml:/app/config.yaml
      - ${DATA_DIR}/mindroom_data:/app/mindroom_data
      - ${DATA_DIR}/logs:/app/logs
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - STORAGE_PATH=/app/mindroom_data
      - MINDROOM_SANDBOX_PROXY_URL=http://sandbox-runner:8766
      - MINDROOM_SANDBOX_PROXY_TOKEN=${MINDROOM_SANDBOX_PROXY_TOKEN:-sandbox-secret}
      - MINDROOM_SANDBOX_EXECUTION_MODE=selective
      - MINDROOM_SANDBOX_PROXY_TOOLS=shell,file,python
      - HOME=/app
      - MEM0_DIR=/app/mindroom_data/memory/mem0  # Used by mem0
      - GOOGLE_REDIRECT_URI=https://${INSTANCE_DOMAIN}/api/google/callback
      - BACKEND_PORT=${BACKEND_PORT:-8765}
    networks:
      - mindroom-network
      - mynetwork
    labels:
      - traefik.enable=true
      # API routes - backend now serves REST and OpenAI-compatible endpoints on port 8765
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.rule=Host(`${INSTANCE_DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/v1`))
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.service=${INSTANCE_NAME:-mindroom}-api
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.priority=100
      - traefik.http.services.${INSTANCE_NAME:-mindroom}-api.loadbalancer.server.port=8765

  sandbox-runner:
    image: ${BACKEND_IMAGE:-deploy-mindroom-backend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.backend
    container_name: ${INSTANCE_NAME:-mindroom}-sandbox-runner
    restart: always
    command: ["/app/run-sandbox-runner.sh"]
    volumes:
      - sandbox-workspace:/app/workspace
    environment:
      - MINDROOM_SANDBOX_RUNNER_MODE=true
      - MINDROOM_SANDBOX_PROXY_TOKEN=${MINDROOM_SANDBOX_PROXY_TOKEN:-sandbox-secret}
    networks:
      - mindroom-network

  frontend:
    image: ${FRONTEND_IMAGE:-deploy-mindroom-frontend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.frontend
    container_name: ${INSTANCE_NAME:-mindroom}-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-8080}:8080"
    volumes:
      - ${DATA_DIR}/logs:/app/logs
    environment:
      - VITE_API_URL=  # Empty for relative URLs
      - HOME=/app
    networks:
      - mindroom-network
      - mynetwork
    labels:
      - traefik.enable=true
      # Frontend routes - serves the UI on port 8080 (nginx-unprivileged default)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.rule=Host(`${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.service=${INSTANCE_NAME:-mindroom}
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.priority=50
      - traefik.http.services.${INSTANCE_NAME:-mindroom}.loadbalancer.server.port=8080

volumes:
  sandbox-workspace:

networks:
  mindroom-network:
    driver: bridge
  mynetwork:
    external: true
