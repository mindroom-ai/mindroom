services:
  # Base image with Python dependencies - built first
  mindroom-base:
    image: mindroom-base:latest
    build:
      context: ..
      dockerfile: deploy/Dockerfile.base
    command: echo "Base image built successfully"

  mindroom-backend:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.backend
    depends_on:
      - mindroom-base
    container_name: mindroom-backend
    restart: always
    env_file:
      - ../.env
    volumes:
      - /mnt/data/mindroom/config:/app/config
      - /mnt/data/mindroom/tmp:/app/tmp
      - /mnt/data/mindroom/logs:/app/logs
    environment:
      - LOG_LEVEL=INFO
      - STORAGE_PATH=/app/tmp
    networks:
      - mynetwork
    labels:
      - traefik.enable=false

  mindroom-frontend:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.frontend
    depends_on:
      - mindroom-base
    container_name: mindroom-frontend
    restart: always
    env_file:
      - ../.env
    volumes:
      - /mnt/data/mindroom/config:/app/config
      - /mnt/data/mindroom/logs:/app/logs
    environment:
      - BACKEND_PORT=8001
      - FRONTEND_PORT=3003
    networks:
      - mynetwork
    labels:
      - traefik.enable=true
      - traefik.http.routers.mindroom.rule=Host(`mindroom.${DOMAIN}`)
      - traefik.http.routers.mindroom.entrypoints=websecure
      - traefik.http.routers.mindroom-local.rule=Host(`mindroom.local`)
      - traefik.http.routers.mindroom-local.entrypoints=web
      - traefik.http.services.mindroom.loadbalancer.server.port=3003

networks:
  mynetwork:
    external: true
