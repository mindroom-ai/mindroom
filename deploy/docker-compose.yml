services:
  backend:
    image: ${BACKEND_IMAGE:-deploy-mindroom-backend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.backend
    container_name: ${INSTANCE_NAME:-mindroom}-backend
    restart: always
    env_file:
      - ../.env
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ${DATA_DIR}/config:/app/config
      - ${DATA_DIR}/tmp:/app/tmp
      - ${DATA_DIR}/logs:/app/logs
      - ${DATA_DIR}/mindroom:/app/.mindroom
      - ${DATA_DIR}/mem0:/app/.mem0
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - STORAGE_PATH=/app/tmp
      - HOME=/app
      - GOOGLE_REDIRECT_URI=https://${INSTANCE_DOMAIN}/api/google/callback
    networks:
      - mindroom-network
    labels:
      - traefik.enable=false

  frontend:
    image: ${FRONTEND_IMAGE:-deploy-mindroom-frontend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.frontend
    container_name: ${INSTANCE_NAME:-mindroom}-frontend
    restart: always
    env_file:
      - ../.env
    ports:
      - "${FRONTEND_PORT:-3003}:3003"
    volumes:
      - ${DATA_DIR}/config:/app/config
      - ${DATA_DIR}/logs:/app/logs
      - ${DATA_DIR}/mindroom:/app/.mindroom
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-8765}
      - FRONTEND_PORT=${FRONTEND_PORT:-3003}
      - VITE_API_URL=
      - HOME=/app
      - GOOGLE_REDIRECT_URI=https://${INSTANCE_DOMAIN}/api/google/callback
    networks:
      - mindroom-network
      - mynetwork
    labels:
      - traefik.enable=true
      # API routes (for the API server on port 8765 in the same container)
      # API has higher priority (100) so it matches first
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.rule=Host(`${INSTANCE_DOMAIN}`) && PathPrefix(`/api`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.service=${INSTANCE_NAME:-mindroom}-api
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-api.priority=100
      - traefik.http.services.${INSTANCE_NAME:-mindroom}-api.loadbalancer.server.port=${BACKEND_PORT:-8765}
      # Frontend routes (for the Vite dev server on port $FRONTEND_PORT)
      # Frontend has lower priority (50) and catches everything else
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.rule=Host(`${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.service=${INSTANCE_NAME:-mindroom}
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.priority=50
      - traefik.http.services.${INSTANCE_NAME:-mindroom}.loadbalancer.server.port=${FRONTEND_PORT:-3003}

networks:
  mindroom-network:
    driver: bridge
  mynetwork:
    external: true
