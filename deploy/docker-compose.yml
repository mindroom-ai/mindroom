services:
  backend:
    image: ${BACKEND_IMAGE:-deploy-mindroom-backend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.backend
    container_name: ${INSTANCE_NAME:-mindroom}-backend
    restart: always
    env_file:
      - ../.env
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "${BACKEND_PORT:-8765}:8765"
    volumes:
      - ${DATA_DIR}/config:/app/config
      - ${DATA_DIR}/tmp:/app/tmp
      - ${DATA_DIR}/logs:/app/logs
      - ${DATA_DIR}/mindroom:/app/.mindroom
      - ${DATA_DIR}/mem0:/app/.mem0
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - STORAGE_PATH=/app/tmp
      - BACKEND_PORT=${BACKEND_PORT:-8765}
      - HOME=/app
    networks:
      - mindroom-network
    labels:
      - traefik.enable=false

  frontend:
    image: ${FRONTEND_IMAGE:-deploy-mindroom-frontend:latest}
    build:
      context: ..
      dockerfile: deploy/Dockerfile.frontend
    container_name: ${INSTANCE_NAME:-mindroom}-frontend
    restart: always
    env_file:
      - ../.env
    ports:
      - "${FRONTEND_PORT:-3003}:3003"
    volumes:
      - ${DATA_DIR}/config:/app/config
      - ${DATA_DIR}/logs:/app/logs
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-8765}
      - FRONTEND_PORT=${FRONTEND_PORT:-3003}
    networks:
      - mindroom-network
      - mynetwork
    labels:
      - traefik.enable=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.rule=Host(`${INSTANCE_DOMAIN:-mindroom.${DOMAIN}}`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-local.rule=Host(`${INSTANCE_NAME:-mindroom}.local`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-local.entrypoints=web
      - traefik.http.services.${INSTANCE_NAME:-mindroom}.loadbalancer.server.port=${FRONTEND_PORT:-3003}

networks:
  mindroom-network:
    driver: bridge
  mynetwork:
    external: true
