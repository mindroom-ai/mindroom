# Production-ready authentication using Traefik Forward Auth
# This is a MUCH better approach than rolling our own

services:
  # Option 1: Traefik Forward Auth with Google/GitHub OAuth
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    container_name: ${INSTANCE_NAME:-mindroom}-auth
    environment:
      - DEFAULT_PROVIDER=google  # or github, oidc
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET=${AUTH_SECRET}  # Random secret, generate with: openssl rand -base64 32
      - COOKIE_DOMAIN=${INSTANCE_DOMAIN}
      - AUTH_HOST=auth.${INSTANCE_DOMAIN}
      - WHITELIST=${AUTH_WHITELIST}  # Comma-separated email addresses
      - LOG_LEVEL=info
    networks:
      - mynetwork
    labels:
      - traefik.enable=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-auth.rule=Host(`auth.${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-auth.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-auth.tls=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-auth.tls.certresolver=porkbun
      - traefik.http.services.${INSTANCE_NAME:-mindroom}-auth.loadbalancer.server.port=4181
      - traefik.http.middlewares.${INSTANCE_NAME:-mindroom}-auth.forwardauth.address=http://traefik-forward-auth:4181
      - traefik.http.middlewares.${INSTANCE_NAME:-mindroom}-auth.forwardauth.authResponseHeaders=X-Forwarded-User

  # Option 2: Authelia (more features, self-hosted)
  authelia:
    image: authelia/authelia:latest
    container_name: ${INSTANCE_NAME:-mindroom}-authelia
    volumes:
      - ${DATA_DIR}/authelia:/config
    environment:
      - TZ=UTC
    networks:
      - mynetwork
    labels:
      - traefik.enable=true
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-authelia.rule=Host(`auth.${INSTANCE_DOMAIN}`)
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-authelia.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}-authelia.tls=true
      - traefik.http.middlewares.${INSTANCE_NAME:-mindroom}-authelia.forwardauth.address=http://authelia:9091/api/verify?rd=https://auth.${INSTANCE_DOMAIN}
      - traefik.http.middlewares.${INSTANCE_NAME:-mindroom}-authelia.forwardauth.trustForwardHeader=true

  # Apply auth middleware to frontend
  frontend:
    labels:
      # Use ONE of these:
      # For Traefik Forward Auth:
      - traefik.http.routers.${INSTANCE_NAME:-mindroom}.middlewares=${INSTANCE_NAME:-mindroom}-auth
      # For Authelia:
      # - traefik.http.routers.${INSTANCE_NAME:-mindroom}.middlewares=${INSTANCE_NAME:-mindroom}-authelia
