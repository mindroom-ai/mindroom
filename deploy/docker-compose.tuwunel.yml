# Tuwunel Matrix Server Overlay for Mindroom Federation
# This adds a lightweight Matrix server to each Mindroom instance
# Usage: docker compose --env-file .env.{instance} -f docker-compose.yml -f docker-compose.tuwunel.yml up -d

services:
  tuwunel:
    image: ghcr.io/matrix-construct/tuwunel:latest
    container_name: ${INSTANCE_NAME:-mindroom}-tuwunel
    restart: unless-stopped
    volumes:
      - ${DATA_DIR:-./instance_data}/tuwunel:/var/lib/tuwunel
      - ./tuwunel.toml:/etc/tuwunel.toml:ro
    command: ["-c", "/etc/tuwunel.toml"]
    environment:
      # Instance-specific overrides via environment variables
      TUWUNEL_SERVER_NAME: ${MATRIX_SERVER_NAME:-${INSTANCE_DOMAIN:-localhost}}
      TUWUNEL_DATABASE_PATH: /var/lib/tuwunel
      TUWUNEL_PORT: ${TUWUNEL_INTERNAL_PORT:-6167}
      TUWUNEL_ALLOW_FEDERATION: ${MATRIX_ALLOW_FEDERATION:-false}
      TUWUNEL_ALLOW_REGISTRATION: ${MATRIX_ALLOW_REGISTRATION:-true}
      TUWUNEL_YES_I_AM_VERY_VERY_SURE_I_WANT_AN_OPEN_REGISTRATION_SERVER_PRONE_TO_ABUSE: ${MATRIX_ALLOW_REGISTRATION:-true}
      TUWUNEL_TRUSTED_SERVERS: '["matrix.org"]'
      TUWUNEL_ADDRESS: 0.0.0.0
      TUWUNEL_MAX_REQUEST_SIZE: 20000000
      TUWUNEL_WELL_KNOWN: |
        {
        client=https://${MATRIX_SERVER_NAME:-${INSTANCE_DOMAIN:-localhost}},
        server=${MATRIX_SERVER_NAME:-${INSTANCE_DOMAIN:-localhost}}:443
        }
    # Federation requires Matrix domains to resolve to Traefik
    # For LOCAL deployments: Add your Matrix domains here pointing to your Docker network gateway
    # To find your gateway IP, run: docker network inspect mynetwork | jq '.[0].IPAM.Config[0].Gateway'
    # For PUBLIC deployments: Remove the entire extra_hosts section
    extra_hosts:
      - "m-default.mindroom.chat:172.20.0.1"
      - "m-alt.mindroom.chat:172.20.0.1"
      - "m-alt2.mindroom.chat:172.20.0.1"
      - "m-default.localhost:172.20.0.1"
      - "m-alt.localhost:172.20.0.1"
      - "m-alt2.localhost:172.20.0.1"
    ulimits:
      nofile:
        soft: 1048567
        hard: 1048567
    networks:
      - mindroom-network
      - mynetwork
    labels:
      - traefik.enable=true

      # Matrix Client and Federation API - HTTPS
      - traefik.http.routers.${INSTANCE_NAME}-matrix.rule=Host(`m-${INSTANCE_DOMAIN:-m-${INSTANCE_NAME}.${DOMAIN}}`)
      - traefik.http.routers.${INSTANCE_NAME}-matrix.entrypoints=websecure
      - traefik.http.routers.${INSTANCE_NAME}-matrix.tls=true
      - traefik.http.routers.${INSTANCE_NAME}-matrix.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME}-matrix.service=${INSTANCE_NAME}-matrix
      - traefik.http.services.${INSTANCE_NAME}-matrix.loadbalancer.server.port=6167

      # Matrix Client API - Local HTTP
      - traefik.http.routers.${INSTANCE_NAME}-matrix-local.rule=Host(`m-${INSTANCE_NAME}.local`)
      - traefik.http.routers.${INSTANCE_NAME}-matrix-local.entrypoints=web
      - traefik.http.routers.${INSTANCE_NAME}-matrix-local.service=${INSTANCE_NAME}-matrix

      # Federation on port 8448
      - traefik.http.routers.${INSTANCE_NAME}-fed.rule=Host(`m-${INSTANCE_DOMAIN:-m-${INSTANCE_NAME}.${DOMAIN}}`)
      - traefik.http.routers.${INSTANCE_NAME}-fed.entrypoints=matrix-fed
      - traefik.http.routers.${INSTANCE_NAME}-fed.tls=true
      - traefik.http.routers.${INSTANCE_NAME}-fed.tls.certresolver=porkbun
      - traefik.http.routers.${INSTANCE_NAME}-fed.service=${INSTANCE_NAME}-matrix

  # Update backend to know about Matrix server
  backend:
    environment:
      MATRIX_HOMESERVER: http://tuwunel:6167
      MATRIX_SERVER_NAME: ${MATRIX_SERVER_NAME:-${INSTANCE_DOMAIN:-localhost}}
    depends_on:
      - tuwunel

networks:
  mindroom-network:
    driver: bridge
  mynetwork:
    external: true
