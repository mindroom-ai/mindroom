#!/usr/bin/env bash
set -euo pipefail

# Simple zellij-based starter that:
# - Ensures Python deps (uv sync) in repo and widget/backend
# - Ensures frontend deps (npm ci/install) in widget/frontend
# - Starts a zellij session with two panes:
#   1) uv run mindroom run   (repo root)
#   2) ./widget/run.sh       (starts widget backend+frontend)

SESSION_NAME="${SESSION_NAME:-mindroom}"

# Resolve repo root regardless of where this script is called from
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." &>/dev/null && pwd)"

echo "Using repo root: $REPO_ROOT"


echo "Syncing Python dependencies in repo root with uv..."
(cd "$REPO_ROOT" && uv sync)

# Backend deps (widget/backend)
if [ -d "$REPO_ROOT/widget/backend" ]; then
  echo "Syncing Python dependencies for widget/backend with uv..."
  (cd "$REPO_ROOT/widget/backend" && uv sync)
fi

# Frontend deps (widget/frontend)
if [ -d "$REPO_ROOT/widget/frontend" ]; then
  echo "Installing frontend dependencies with pnpm..."
  if [ -f "$REPO_ROOT/widget/frontend/pnpm-lock.yaml" ]; then
    (cd "$REPO_ROOT/widget/frontend" && pnpm install --frozen-lockfile)
  else
    (cd "$REPO_ROOT/widget/frontend" && pnpm install)
  fi
fi

# Use the permanent layout file
LAYOUT_FILE="$REPO_ROOT/scripts/zellij-mindroom.kdl"

# Function to show usage instructions
show_usage() {
    echo "‚ùå Use 'Ctrl-Q' to quit Zellij"
    echo "üîå Use 'Ctrl-O d' to detach from the session"
    echo "üîó Use 'scripts/attach' to reattach"
}

# Function to start a new Zellij session
start_new_session() {
    cd "$REPO_ROOT"
    if [ "${MINDROOM_NO_ATTACH:-false}" = "true" ]; then
        # Start detached - use a subshell to avoid terminal attachment
        (
            # The session_name in KDL file ensures it creates "mindroom" session
            nohup zellij --layout "$LAYOUT_FILE" </dev/null >/dev/null 2>&1 &
        )
        sleep 2  # Give it time to start
        echo "‚úÖ Session '$SESSION_NAME' started in background."
        echo "Run: scripts/attach   to attach"
        echo "Run: scripts/stop     to stop the session"
    else
        show_usage
        # Start zellij with layout file - session name is specified in the layout
        exec zellij --layout "$LAYOUT_FILE"
    fi
}

# Strip ANSI color codes for proper session detection
get_sessions() {
    zellij list-sessions 2>/dev/null | sed $'s/\033\\[[0-9;]*m//g' || true
}

# Check if session already exists
sessions="$(get_sessions)"

# Case 1: Session exists but has exited - clean it up and start fresh
if echo "$sessions" | grep "$SESSION_NAME" | grep -q "EXITED"; then
    echo "üßπ Found exited session '$SESSION_NAME'. Cleaning up..."
    zellij delete-session "$SESSION_NAME" 2>/dev/null || true
    echo "üÜï Starting fresh services in Zellij..."
    start_new_session
# Case 2: Session exists and is running - attach to it if requested
elif echo "$sessions" | awk '{print $1}' | grep -qx "$SESSION_NAME"; then
    if [ "${MINDROOM_NO_ATTACH:-false}" = "true" ]; then
        echo "‚úÖ Session '$SESSION_NAME' is already running. Not attaching as requested."
        echo "Run: scripts/attach   to attach"
        echo "Run: scripts/stop     to stop the session"
    else
        echo "üîó Session '$SESSION_NAME' already exists and is running. Attaching..."
        show_usage
        cd "$REPO_ROOT"
        exec zellij attach "$SESSION_NAME"
    fi
# Case 3: No session exists - create a new one
else
    echo "üöÄ Starting mindroom services in Zellij..."
    start_new_session
fi
