#!/usr/bin/env bash
set -euo pipefail

# Attach to the zellij session used by MindRoom helper scripts.
SESSION_NAME="${SESSION_NAME:-mindroom}"

require_cmd() {
  if ! command -v "$1" &>/dev/null; then
    echo "Error: '$1' is not installed or not on PATH."
    case "$1" in
      zellij)
        echo "Install zellij: https://zellij.dev/"
        ;;
    esac
    exit 1
  fi
}

require_cmd zellij

# Check if session exists (strip ANSI color codes)
sessions="$(zellij list-sessions 2>/dev/null || zellij ls 2>/dev/null || true)"
sessions_clean="$(echo "$sessions" | sed 's/\x1b\[[0-9;]*m//g')"
if ! echo "$sessions_clean" | awk '{print $1}' | grep -qx "$SESSION_NAME"; then
  echo "No zellij session named '$SESSION_NAME' found."
  echo "Start it with: scripts/start"
  exit 1
fi

# Try common attach forms for compatibility across versions
exec zellij attach -s "$SESSION_NAME" 2>/dev/null || \
exec zellij a -s "$SESSION_NAME" 2>/dev/null || \
exec zellij --session "$SESSION_NAME" attach
