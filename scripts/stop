#!/usr/bin/env bash
set -euo pipefail

# Stop the zellij session used by MindRoom helper scripts.
SESSION_NAME="${SESSION_NAME:-mindroom}"

require_cmd() {
  if ! command -v "$1" &>/dev/null; then
    echo "Error: '$1' is not installed or not on PATH."
    case "$1" in
      zellij)
        echo "Install zellij: https://zellij.dev/"
        ;;
    esac
    exit 1
  fi
}

require_cmd zellij

# Check if session exists (strip ANSI color codes)
sessions="$(zellij list-sessions 2>/dev/null || zellij ls 2>/dev/null || true)"
sessions_clean="$(echo "$sessions" | sed $'s/\033\\[[0-9;]*m//g')"
if ! echo "$sessions_clean" | awk '{print $1}' | grep -qx "$SESSION_NAME"; then
  echo "No zellij session named '$SESSION_NAME' found. Nothing to stop."
  exit 0
fi

echo "Stopping zellij session '$SESSION_NAME'..."

# Try common kill-session variants for compatibility across versions
zellij kill-session "$SESSION_NAME" 2>/dev/null || \
zellij kill-session -s "$SESSION_NAME" 2>/dev/null || \
zellij action -s "$SESSION_NAME" kill-session 2>/dev/null || true

# Wait briefly for session to terminate
for _ in $(seq 1 50); do
  sleep 0.1
  sessions_now="$(zellij list-sessions 2>/dev/null || zellij ls 2>/dev/null || true)"
  sessions_now_clean="$(echo "$sessions_now" | sed $'s/\033\\[[0-9;]*m//g')"
  if ! echo "$sessions_now_clean" | awk '{print $1}' | grep -qx "$SESSION_NAME"; then
    echo "Session '$SESSION_NAME' stopped."
    exit 0
  fi
done

echo "Warning: session '$SESSION_NAME' still appears to be running."
echo "You may need to manually kill it or check for stuck processes."
exit 1
